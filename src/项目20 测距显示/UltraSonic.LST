C51 COMPILER V9.00   ULTRASONIC                                                            08/22/2015 13:58:10 PAGE 1   


C51 COMPILER V9.00, COMPILATION OF MODULE ULTRASONIC
OBJECT MODULE PLACED IN UltraSonic.OBJ
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE UltraSonic.c BROWSE DEBUG OBJECTEXTEND

line level    source

   1          /**********************BST-M51实验开发板例程************************
   2          *  平台：BST-M51 + Keil U4 + STC89C52
   3          *  名称：超声波测距实验(1602液晶屏显示)
   4          *  公司：深圳市亚博软件开发有限公司       
   5          *  日期：2015-7
   6          *  晶振:11.0592MHZ
   7          ******************************************************************/
   8          /**********************************包含头文件**********************************/
   9          #include <reg52.h>
  10          #include "1602.h"
  11          /************************************宏定义************************************/
  12          #define VELOCITY_30C    3495       //30摄氏度时的声速，声速V= 331.5 + 0.6*温度； 
  13          #define VELOCITY_23C    3453       //23摄氏度时的声速，声速V= 331.5 + 0.6*温度； 
  14          /************************************位定义************************************/
  15          sbit INPUT  = P2^0;                //回声接收端口
  16          sbit OUTPUT = P2^1;                //超声触发端口
  17          sbit Beep   = P2^3 ;                       // 蜂鸣器　
  18          /********************************定义变量和数组********************************/
  19          long int distance=0;               //距离变量
  20          uchar table[]="    Welcome to   ";
  21          uchar table0[]="  learn  BST-M51  ";
  22          uchar table1[]="There's no echo.";
  23          uchar table2[]="     BST-M51      ";
  24          uchar table3[]="Distance:";
  25          uchar count;
  26          /***********************************函数声明***********************************/
  27          extern void initLCD();
  28          extern void write_date(uchar date);
  29          extern void write_com(uchar com);
  30          extern void delay(uint x);
  31          /******************************************************************************/
  32          /* 函数名称  : Delay_xMs                                                      */
  33          /* 函数描述  : 延时函数                                                       */
  34          /* 输入参数  : x                                                              */
  35          /* 参数描述  : 延时时间                                                       */
  36          /* 返回值    : 无                                                             */
  37          /******************************************************************************/
  38          void Delay_xMs(unsigned int x)
  39          {
  40   1          unsigned int i,j;
  41   1          for(i = 0;i < x;i++ )
  42   1          {
  43   2              for(j = 0;j < 3;j++ )
  44   2              {
  45   3                  ;
  46   3              }
  47   2          }
  48   1      }
  49          /******************************************************************************/
  50          /* 函数名称  : Alarm                                                          */
  51          /* 函数描述  : 蜂鸣器发声函数                                                 */
  52          /* 输入参数  : t                                                              */
  53          /* 参数描述  : 发声的次数                                                     */
  54          /* 返回值    : 无                                                             */
  55          /******************************************************************************/
C51 COMPILER V9.00   ULTRASONIC                                                            08/22/2015 13:58:10 PAGE 2   

  56          void Alarm(uchar t)
  57          {
  58   1              uchar i;
  59   1              for(i = 0;i < t;i++)
  60   1              {
  61   2                      Beep = 0;
  62   2                      Delay_xMs(1000);
  63   2                      Beep = 1;
  64   2                      Delay_xMs(1000);
  65   2              }
  66   1      }       
  67          /******************************************************************************/
  68          /* 函数名称  : delayt                                                         */
  69          /* 函数描述  : 延时函数                                                       */
  70          /* 输入参数  : x                                                              */
  71          /* 参数描述  : 延时时间数据                                                   */
  72          /* 返回值    : 无                                                             */
  73          /******************************************************************************/        
  74          void delayt(uint x)
  75          {
  76   1          uchar j;
  77   1          while(x-- > 0)
  78   1          {
  79   2                  for(j = 0;j < 125;j++)
  80   2              {
  81   3                  ;
  82   3              }
  83   2          }
  84   1      }
  85          /******************************************************************************/
  86          /* 函数名称  : Init_MCU                                                       */
  87          /* 函数描述  : 初始化单片机函数                                               */
  88          /* 输入参数  : 无                                                             */
  89          /* 参数描述  : 无                                                             */
  90          /* 返回值    : 无                                                             */
  91          /******************************************************************************/
  92          void Init_MCU(void)
  93          {
  94   1              TMOD = 0x01;      //定时器2初始化,设置为16位自动重装模式
  95   1              TL0 = 0x66;
  96   1              TH0 = 0xfc;           //1ms
  97   1          ET0 = 1;          //开定时器2
  98   1              EA = 1;               //总中断使能
  99   1      }
 100          /******************************************************************************/
 101          /* 函数名称  : Init_Parameter                                                 */
 102          /* 函数描述  : 初始化参数和IO口函数                                           */
 103          /* 输入参数  : 无                                                             */
 104          /* 参数描述  : 无                                                             */
 105          /* 返回值    : 无                                                             */
 106          /******************************************************************************/
 107          void Init_Parameter(void)
 108          {
 109   1               OUTPUT =1;
 110   1               INPUT = 1;
 111   1               count = 0;
 112   1               distance = 0;
 113   1      }
 114          /******************************************************************************/
 115          /* 函数名称  : display_char                                                   */
 116          /* 函数描述  : 显示字符串函数                                                 */
 117          /* 输入参数  : point,address                                                  */
C51 COMPILER V9.00   ULTRASONIC                                                            08/22/2015 13:58:10 PAGE 3   

 118          /* 参数描述  : 写入的字符串的地址指针 1602显示对应的地址                      */
 119          /* 返回值    : 无                                                             */
 120          /******************************************************************************/
 121          void display_char(uchar *point,uchar address)
 122          {
 123   1              uchar i;
 124   1              write_com(0x80 + address);
 125   1              for(i = 0;i < 16; i++)
 126   1              {
 127   2                      write_date(*point);
 128   2                      point++;
 129   2              }
 130   1      }
 131          /******************************************************************************/
 132          /* 函数名称  : display                                                        */
 133          /* 函数描述  : 显示数字                                                       */
 134          /* 输入参数  : number，address                                                */
 135          /* 参数描述  : number写入的数据，address地址                                  */
 136          /* 返回值    : 无                                                             */
 137          /******************************************************************************/        
 138          void display(int number,uchar address)
 139          {
 140   1              uchar b,c,d,e;
 141   1              b= (number / 1000);
 142   1              c= (number / 100) % 10;
 143   1              d = (number / 10) % 10;
 144   1              e = number % 10;
 145   1      
 146   1              write_com(0x80 + address);
 147   1          write_date(b + 48);
 148   1              write_date(c + 48);
 149   1              write_date(d + 48);
 150   1              write_date(46);           //小数点的ASCII
 151   1              write_date(e + 48);
 152   1          write_date(99);           //"c"的ASCII
 153   1              write_date(109);          //"m"的ASCII
 154   1      }
 155          /******************************************************************************/
 156          /* 函数名称  : Trig_SuperSonic                                                */
 157          /* 函数描述  : 发出声波函数                                                   */
 158          /* 输入参数  : 无                                                             */
 159          /* 参数描述  : 无                                                             */
 160          /* 返回值    : 无                                                             */
 161          /******************************************************************************/
 162          void Trig_SuperSonic(void)//出发声波
 163          {
 164   1               OUTPUT = 1;
 165   1               delayt(1);
 166   1               OUTPUT = 0;
 167   1      }
 168          /******************************************************************************/
 169          /* 函数名称  : Measure_Distance                                               */
 170          /* 函数描述  : 计算距离函数                                                   */
 171          /* 输入参数  : 无                                                             */
 172          /* 参数描述  : 无                                                             */
 173          /* 返回值    : 无                                                             */
 174          /******************************************************************************/
 175          void Measure_Distance(void)
 176          {
 177   1              uchar l;
 178   1              uint h,y;
 179   1              TR0 = 1;
C51 COMPILER V9.00   ULTRASONIC                                                            08/22/2015 13:58:10 PAGE 4   

 180   1              while(INPUT)
 181   1          {
 182   2              ;
 183   2          }   
 184   1              TR0 = 0;
 185   1              l = TL0;
 186   1              h = TH0;
 187   1              y = (h << 8) + l;
 188   1              y = y - 0xfc66;//us部分
 189   1              distance = y + 1000 * count;//计算总时间
 190   1              TL0 = 0x66;
 191   1              TH0 = 0xfc;
 192   1              delayt(30);
 193   1              distance = VELOCITY_30C * distance / 20000;
 194   1      }
 195          /******************************************************************************/
 196          /* 函数名称  : main                                                           */
 197          /* 函数描述  : 主函数                                                         */
 198          /* 输入参数  : 无                                                             */
 199          /* 参数描述  : 无                                                             */
 200          /* 返回值    : 无                                                             */
 201          /******************************************************************************/                                        
 202          void main(void)
 203          {       
 204   1          rw = 0;
 205   1              initLCD();
 206   1              Init_MCU();
 207   1              Init_Parameter();
 208   1              Alarm(2);
 209   1              display_char(table,0x00);
 210   1              display_char(table0,0x40);
 211   1              Delay_xMs(30000);
 212   1              display_char(table2,0x00);
 213   1              display_char(table1,0x40);
 214   1      
 215   1              while(1)
 216   1              {
 217   2                       Trig_SuperSonic();         //触发超声波发射
 218   2                       while(INPUT == 0)          //等待回声
 219   2               {
 220   3                   ;
 221   3               }
 222   2                       Measure_Distance();        //计算脉宽并转换为距离
 223   2                       display_char(table3,0x40);
 224   2                       display(distance,0x49);    //显示距离
 225   2                       Init_Parameter();          // 参数重新初始化
 226   2                       delayt(100);               //延时，两次发射之间要至少有10ms间隔
 227   2               }      
 228   1      }
 229          /******************************************************************************/
 230          /* 函数名称  : timer0                                                         */
 231          /* 函数描述  : T0中断处理函数                                                 */
 232          /* 输入参数  : 无                                                             */
 233          /* 参数描述  : 无                                                             */
 234          /* 返回值    : 无                                                             */
 235          /******************************************************************************/
 236          void timer0 (void) interrupt 1
 237          {
 238   1              TF0 = 0;
 239   1              TL0 = 0x66;
 240   1              TH0 = 0xfc;
 241   1              count++;
C51 COMPILER V9.00   ULTRASONIC                                                            08/22/2015 13:58:10 PAGE 5   

 242   1              if(count == 18)//超声波回声脉宽最多18ms
 243   1              {
 244   2                      TR0 =0;
 245   2                      TL0 = 0x66;
 246   2                      TH0 = 0xfc;
 247   2                      count = 0;
 248   2              }
 249   1      }
 250          /******************************************************************************/


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    644    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     88       6
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
